# 传输层

## 传输服务

**传输层的目的**：提供高效的、可靠的和成本有效的数据传输服务

**传输层和网络层的区别**：传输层的代码完全运行在用户的机器上，但是网络层的代码主要运行在运营商操作的路由器上，用户对网络层没有真正的控制权，不能用更好的路由器或者再数据链路层上用更好的错误处理机制来解决服务太差的问题

## 传输协议的要素

### 数据链路层和传输层的区别

- 在传输层需要显示地指定接收方的人地址
- 在传输层中，初始地连接建立过程复杂
- 网络存在潜在地存储容量，具有延迟和重复数据包地特性
- 传输层存在大量并且数量可变地连接，由于连接之间地相互竞争造成连接地可用带宽上下波动

### 寻址

- **传输服务访问点**：传输层地一个特殊端点（端口），为监听连接请求地进程定义地相应传输地址
- **网络服务访问点**：IP地址

### 差错控制和流量控制

**差错控制**：确保数据传输具备所需的可靠性，所有的数据被无差别的传送到目的地。
**流量控制**：防止快速发送端淹没慢速接收端

**解决方法**
1. 帧携带检错码
2. 帧携带的序号用于标识本帧，发送发在接收到接收方成功接收后返回的确认之前重发帧 **自动重复请求**。
3. 停等式
4. 滑动窗口，被用于支持数据的双向传输

## 多路复用

如果主机只有一个网络地址可用，该机器上的所有传输链接都必须使用这个地址。当到达一个段，必须有某种方法告知吧它交给哪个进程处理。

**逆向多路复用**：一个连接上的流量分摊到多条网络路径

## 拥塞控制

- 最大-最小公平性
- 调整发送速率

## UDP 用户数据报协议

UDP没有流量控制、拥塞控制，或者接收到一个坏段后地重传机制。只提供了一个IP协议地接口，并在此接口上增加端口号复用多个进程地功能

![UDP-Header](http://p82ueiq23.bkt.clouddn.com/UDP-Header.png)

### 远程过程调用

允许本地程序调用远程主机上地过程，信息以参数地形式从调用方传输到被调用方，而过程地执行结果则反方向地传递回来。

RPC的思想：尽可能地使一个远程过程调用看起来像本地过程调用；客户程序需要绑定到一个库过程（客户存根），代表客户地址空间中地服务器过程，服务器绑定到称为 **服务器存根** 的过程

**复制-恢复调用**

## TCP 传输控制协议

![tcp-header](http://p82ueiq23.bkt.clouddn.com/tcp-header.png)

- Seq：当前
- 确认号：下一个期待的字节
- ECN、CWR：拥塞控制信号
- Urgent
- ACK：确认号字段有效
- PSH：被推送的数据，请求接收端一旦接收数据就立即将数据递交应用程序
- RST：重置连接
- SYN：用于建立连接的过程
- FIN：被用于释放连接

### TCP连接建立

![tcp-connection-made-three-way-handshake](http://p82ueiq23.bkt.clouddn.com/tcp-connection-made-three-way-handshake.png)

### TCP释放连接

![tcp-connection-closed-four-way-handshake](http://p82ueiq23.bkt.clouddn.com/tcp-connection-closed-four-way-handshake.png)

### TCP滑动窗口

### TCP计时器管理

### TCP拥塞控制

![RoundTrip](http://p82ueiq23.bkt.clouddn.com/RoundTrip.png)

1. 慢开始：在主机刚刚开始发送报文段时可先将拥塞窗口 cwnd 设置为一个最大报文段 MSS 的数值。在每收到一个对新的报文段的确认后，将拥塞窗口增加至多一个 MSS 的数值。用这样的方法逐步增大发送端的拥塞窗口 cwnd，可以使分组注入到网络的速率更加合理。
2. 拥塞避免：让拥塞窗口缓慢增大，每经过一个往返时间就加1，
3. 快重传算法：发送方只要一连收到三个重复确认就应当重传对方尚未收到的报文。而不必等到该分组的重传计时器到期。
4. 快恢复算法：
    1. 当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，把慢开始门限 ssthresh 减半。但接下去不执行慢开始算法。
    2. 由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，即拥塞窗口 cwnd 现在不设置为 1，而是设置为慢开始门限 ssthresh 减半后的数值，然后开始执行拥塞避免算法（“加法增大”），使拥塞窗口缓慢地线性增大.

## TCP UDP 区别

**TCP与UDP区别总结**：
1. TCP面向连接（如打电话要先拨号建立连接）;UDP是无连接的，即发送数据之前不需要建立连接
2. TCP提供可靠的服务。也就是说，通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达;UDP尽最大努力交付，即不保   证可靠交付
3. TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流;UDP是面向报文的
4. UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）
5. 每一条TCP连接只能是点到点的;UDP支持一对一，一对多，多对一和多对多的交互通信
6. TCP首部开销20字节;UDP的首部开销小，只有8个字节
7. TCP的逻辑通信信道是全双工的可靠信道，UDP则是不可靠信道


![UDP-TCP](http://p82ueiq23.bkt.clouddn.com/UDP-TCP.png)

![TCPIP](http://p82ueiq23.bkt.clouddn.com/TCPIP.jpg)