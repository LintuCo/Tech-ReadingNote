## 虚拟机类加载机制

__类的加载__: 类的加载指的是将类的.class文件中的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个java.lang.Class对象，用来封装类在方法区内的数据结构。

### 类的加载过程

JVM将类的加载分为3个步骤： 

1. 装载（Load） 
2. 链接（Link）
3. 初始化（Initialize）

其中 链接（Link）又分3个步骤，如下图所示：

![类的加载过程](https://pic2.zhimg.com/80/v2-5473646d79609214433ee7a66e594603_hd.jpg)

### 1. 装载

1. 通过一个类的全限定名来获取其定义的二进制字节流。 
2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。 
3. 在Java堆中生成一个代表这个类的java.lang.Class对象，作为对方法区中这些数据的访问入口。 

### 2. 链接

- 验证：确保被加载的类的正确性
    + __文件格式验证__：验证字节流是否符合Class文件格式的规范
    + __元数据验证__：对字节码描述的信息进行语义分析,以保证其描述的信息符合Java语言规范的要求。
    + __字节码验证__：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。
    + __符号引用验证__：确保解析动作能正确执行

- 准备：为类的静态变量分配内存，并将其初始化为默认值

- 解析：把类中的符号引用转换为直接引用

### 3. 初始化

对类的静态变量，静态代码块执行初始化操作
- 声明类变量是指定初始值。 
- 使用静态代码块为类变量指定初始值。

__类的初始化：__

- 1）创建类的实例，也就是new一个对象 
- 2）访问某个类或接口的静态变量，或者对该静态变量赋值
- 3）调用类的静态方法
- 4）反射（Class.forName("com.lyj.load")）
- 5）初始化一个类的子类（会首先初始化子类的父类）
- 6）JVM启动时标明的启动类，即文件名和类名相同的那个类

### 类的加载

类的加载指的是将类的.class文件中的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个这个类的Java.lang.Class对象，用来封装类在方法区类的对象。

![类的加载](https://pic2.zhimg.com/80/v2-50658534f3b3fcbab4b89af0a334619b_hd.jpg)

加载类的方法：

1. 从本地系统直接加载
2. 通过网络下载.class文件
3. 从zip，jar等归档文件中加载.class文件 
4. 从专有数据库中提取.class文件 
5. 将Java源文件动态编译为.class文件（服务器）
6. 命令行启动应用时候由JVM初始化加载 
7. 通过Class.forName()方法动态加载 
8. 通过ClassLoader.loadClass()方法动态加载

## 类加载器

### 双亲委派模型

如果一个类加载器收到一个类加载请求，会把这个请求委派给父类加载器完成，每一层次的加载器都是如此，只有当父加载器无法完成加载请求时，子加载器才会尝试自己去加载。

**优点**：Java类随着类加载器具有一种带有优先级的层次关系。